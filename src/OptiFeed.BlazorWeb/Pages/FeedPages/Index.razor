@page "/feeds"
@using OptiFeed.Core.Models


<MCard>
    <MCardTitle>
        <MSpacer></MSpacer>
        <MTextField @bind-Value="_search"
                    AppendIcon="mdi-magnify"
                    Label="Search"
                    SingleLine
                    HideDetails="true"></MTextField>
    </MCardTitle>
    <MDataTable Headers="_headers"
                Items="_feeds"
                Search="@_search"
                Class="elevation-1">
        <TopContent>
            <MToolbar Flat>
                <MToolbarTitle>Feeds</MToolbarTitle>
                <MDivider Class="mx-4"
                          Inset
                          Vertical></MDivider>
                <MSpacer></MSpacer>
                <MButton Color="primary"
                         Dark
                         Class="mb-2"
                         OnClick="()=>_dialog=true">
                    New Feed
                </MButton>
                <MDialog @bind-Value="_dialog"
                         MaxWidth="500">
                    <MCard>
                        <MCardTitle>
                            <span class="text-h5">@FormTitle</span>
                        </MCardTitle>

                        <MCardText>
                            <MContainer>
                                <MRow>
                                    <MCol Cols="12"
                                          Sm="6"
                                          Md="4">
                                        <MTextField @bind-Value="_editedItem.Name"
                                                    Label="Feed name"></MTextField>
                                    </MCol>
                                    <MCol Cols="12"
                                          Sm="6"
                                          Md="4">
                                        <MTextField @bind-Value="_editedItem.DryMatter"
                                                    Label="Dry Matter (%)"></MTextField>
                                    </MCol>
                                    <MCol Cols="12"
                                          Sm="6"
                                          Md="4">
                                        <MTextField @bind-Value="_editedItem.EnergyContent"
                                                    Label="EnergyContent (Mcal/kg)"></MTextField>
                                    </MCol>
                                    <MCol Cols="12"
                                          Sm="6"
                                          Md="4">
                                        <MTextField @bind-Value="_editedItem.ProteinContent"
                                                    Label="Protein (g/kg)"></MTextField>
                                    </MCol>
                                    <MCol Cols="12"
                                          Sm="6"
                                          Md="4">
                                        <MTextField @bind-Value="_editedItem.CostPerKg"
                                                    Label="Cost ($/kg)"></MTextField>
                                    </MCol>
                                    <MCol Cols="12"
                                          Sm="6"
                                          Md="4">
                                        <MTextField @bind-Value="_editedItem.MaxUsage"
                                                    Label="MaxUsage (kg)"></MTextField>
                                    </MCol>
                                </MRow>
                            </MContainer>
                        </MCardText>

                        <MCardActions>
                            <MSpacer></MSpacer>
                            <MButton Color="blue darken-1"
                                     Text
                                     OnClick="Close">
                                Cancel
                            </MButton>
                            <MButton Color="blue darken-1"
                                     Text
                                     OnClick="Save">
                                Save
                            </MButton>
                        </MCardActions>
                    </MCard>
                </MDialog>
                <MDialog @bind-Value="_dialogDelete" MaxWidth="500">
                    <MCard>
                        <MCardTitle Class="text-h5">Are you sure you want to delete this item?</MCardTitle>
                        <MCardActions>
                            <MSpacer></MSpacer>
                            <MButton Color="blue darken-1" Text OnClick="CloseDelete">Cancel</MButton>
                            <MButton Color="blue darken-1" Text OnClick="DeleteItemConfirm">OK</MButton>
                            <MSpacer></MSpacer>
                        </MCardActions>
                    </MCard>
                </MDialog>
            </MToolbar>
        </TopContent>
        <ItemColContent>
            @if (context.Header.Value == "actions")
            {
                <MIcon Small
                       Class="mr-2"
                       OnClick="()=>EditItem(context.Item)">mdi-pencil</MIcon>
                <MIcon Small
                       OnClick="()=>DeleteItem(context.Item)">mdi-delete</MIcon>
            }
            else
            {
                @context.Value
            }
        </ItemColContent>
        <NoDataContent>
            <MButton Color="primary"
                     OnClick="Initialize">
                Reset
            </MButton>
        </NoDataContent>
    </MDataTable>
</MCard>
@code {

    private string _search;


    private List<DataTableHeader<Feed>> _headers = new List<DataTableHeader<Feed>>
{
          new (){ Text= "Name", Value= nameof(Feed.Name),Sortable = true},
          new (){ Text= "Dry Matter (%)", Value= nameof(Feed.DryMatter),Sortable = true},
          new (){ Text= "Energy (Mcal/kg)", Value= nameof(Feed.EnergyContent),Sortable = true},
          new (){ Text= "Protein (g/kg)", Value= nameof(Feed.ProteinContent),Sortable = true},
          new (){ Text= "ADF (%/kg)", Value= nameof(Feed.ProteinContent),Sortable = false},
          new (){ Text= "NDF (%/kg)", Value= nameof(Feed.ProteinContent),Sortable = false},
          new (){ Text= "Cost ($/kg)", Value= nameof(Feed.CostPerKg),Sortable = true},
          new (){ Text= "Max Usage (kg)", Value= nameof(Feed.MaxUsage),Sortable = true},
          new (){ Text= "Actions", Value= "actions",Sortable=false }
    };

    private List<Feed> _feeds;

    private bool _dialog;
    private bool _dialogDelete;
    private Feed _editedItem = new Feed
    {
        Name = "",
        DryMatter = 0,
        ProteinContent = 0,
        EnergyContent = 0,
        CostPerKg = 0,
        MaxUsage = 0,
        ADFContent = 0,
        NDFContent = 0
    };
    private int _editedIndex = -1;

    public string FormTitle
    {
        get
        {
            return _editedIndex == -1 ? "New Item" : "Edit Item";
        }
    }

    protected override void OnInitialized()
    {
        Initialize();
    }

    public void Initialize()
    {
        _feeds = new List<Feed>
{
            new Feed { Name = "Mısır Silajı", EnergyContent = 2.2, ProteinContent = 80,NDFContent = 40.0, ADFContent = 30.0,  CostPerKg = 0.30, MaxUsage = 40, DryMatter = 35, MinUsage = 5 },
            new Feed { Name = "Yonca Kuru Otu", EnergyContent = 2.5, ProteinContent = 180,NDFContent = 40.0, ADFContent = 30.0, CostPerKg = 0.50, MaxUsage = 20, DryMatter = 85,MinUsage = 5 },
            new Feed { Name = "Buğday Kepeği", EnergyContent = 2.6, ProteinContent = 160,NDFContent = 40.0, ADFContent = 30.0, CostPerKg = 0.40, MaxUsage = 15, DryMatter = 89,MinUsage = 5 },
            new Feed { Name = "Arpa", EnergyContent = 3.0, ProteinContent = 120,NDFContent = 40.0, ADFContent = 30.0, CostPerKg = 0.35, MaxUsage = 25, DryMatter = 88,MinUsage = 5 },
            new Feed { Name = "Pamuk Tohumu", EnergyContent = 3.1, ProteinContent = 210,NDFContent = 40.0, ADFContent = 30.0, CostPerKg = 0.60, MaxUsage = 10, DryMatter = 92,MinUsage = 5 },
            new Feed { Name = "Soya Küspesi", EnergyContent = 3.2, ProteinContent = 440,NDFContent = 40.0, ADFContent = 30.0, CostPerKg = 0.70, MaxUsage = 10, DryMatter = 90,MinUsage = 5 },
            new Feed { Name = "Melas", EnergyContent = 2.4, ProteinContent = 50,NDFContent = 40.0, ADFContent = 30.0, CostPerKg = 0.25, MaxUsage = 5, DryMatter = 75,MinUsage = 5 },
            new Feed { Name = "Buğday", EnergyContent = 3.1, ProteinContent = 130,NDFContent = 40.0, ADFContent = 30.0, CostPerKg = 0.45, MaxUsage = 30, DryMatter = 87,MinUsage = 5 },
            new Feed { Name = "Ayçiçeği Küspesi", EnergyContent = 2.8, ProteinContent = 280,NDFContent = 40.0, ADFContent = 30.0, CostPerKg = 0.55, MaxUsage = 15, DryMatter = 88,MinUsage = 5 },
            new Feed { Name = "Şeker Pancarı Posası", EnergyContent = 2.0, ProteinContent = 90,NDFContent = 40.0, ADFContent = 30.0, CostPerKg = 0.30, MaxUsage = 35, DryMatter = 20,MinUsage = 5 },
            new Feed { Name = "Yulaf", EnergyContent = 2.7, ProteinContent = 140,NDFContent = 40.0, ADFContent = 30.0, CostPerKg = 0.40, MaxUsage = 20, DryMatter = 86,MinUsage = 5 },
            new Feed { Name = "Mısır Tane", EnergyContent = 3.4, ProteinContent = 90,NDFContent = 40.0, ADFContent = 30.0, CostPerKg = 0.50, MaxUsage = 30, DryMatter = 88,MinUsage = 5 },
            new Feed { Name = "Çavdar", EnergyContent = 3.0, ProteinContent = 110,NDFContent = 40.0, ADFContent = 30.0, CostPerKg = 0.40, MaxUsage = 20, DryMatter = 85,MinUsage = 5 },
            new Feed { Name = "Kuru Yonca Peleti", EnergyContent = 2.4, ProteinContent = 180,NDFContent = 40.0, ADFContent = 30.0, CostPerKg = 0.55, MaxUsage = 15, DryMatter = 90,MinUsage = 5 },
            new Feed { Name = "Pamuk Tohumu Küspesi", EnergyContent = 2.9, ProteinContent = 250,NDFContent = 40.0, ADFContent = 30.0, CostPerKg = 0.65, MaxUsage = 15, DryMatter = 91,MinUsage = 5 },
            new Feed { Name = "Bezelye", EnergyContent = 2.7, ProteinContent = 220,NDFContent = 40.0, ADFContent = 30.0, CostPerKg = 0.45, MaxUsage = 15, DryMatter = 87,MinUsage = 5 },
            new Feed { Name = "Yonca Silajı", EnergyContent = 2.1, ProteinContent = 150,NDFContent = 40.0, ADFContent = 30.0, CostPerKg = 0.35, MaxUsage = 25, DryMatter = 40,MinUsage = 5 },
            new Feed { Name = "Mısır Gluteni", EnergyContent = 3.3, ProteinContent = 600,NDFContent = 40.0, ADFContent = 30.0, CostPerKg = 0.70, MaxUsage = 8, DryMatter = 89,MinUsage = 5 },
            new Feed { Name = "Kuru Arpa Posası", EnergyContent = 2.9, ProteinContent = 170,NDFContent = 40.0, ADFContent = 30.0, CostPerKg = 0.40, MaxUsage = 20, DryMatter = 92,MinUsage = 5 },
            new Feed { Name = "Nohut", EnergyContent = 2.6, ProteinContent = 200,NDFContent = 40.0, ADFContent = 30.0, CostPerKg = 0.55, MaxUsage = 12, DryMatter = 90,MinUsage = 5 }
        };
    }

    public void Close()
    {
        _dialog = false;
        _editedItem = new Feed();
        _editedIndex = -1;
    }

    public void Save()
    {
        if (_editedIndex > -1)
        {
            var item = _feeds[_editedIndex];
            item.MaxUsage = _editedItem.MaxUsage;
            item.MinUsage = _editedItem.MinUsage;
            item.DryMatter = _editedItem.DryMatter;
            item.EnergyContent = _editedItem.EnergyContent;
            item.ProteinContent = _editedItem.ProteinContent;
            item.CostPerKg = _editedItem.CostPerKg;
            item.Name = _editedItem.Name;
            item.ADFContent = _editedItem.ADFContent;
            item.NDFContent = _editedItem.NDFContent;

        }
        else
        {
            _feeds.Add(_editedItem);
        }
        Close();
    }

    public void EditItem(Feed item)
    {
        _editedIndex = _feeds.IndexOf(item);
        _editedItem = new Feed()
        {
            DryMatter = item.DryMatter,
            EnergyContent = item.EnergyContent,
            ProteinContent = item.ProteinContent,
            Name = item.Name,
            CostPerKg = item.CostPerKg,
            MaxUsage = item.MaxUsage,
            MinUsage = item.MinUsage,
            ADFContent = item.ADFContent,
            NDFContent = item.NDFContent
        };
        _dialog = true;
    }

    public void DeleteItem(Feed item)
    {
        _editedIndex = _feeds.IndexOf(item);
        _editedItem = new Feed()
        {
            DryMatter = item.DryMatter,
            EnergyContent = item.EnergyContent,
            ProteinContent = item.ProteinContent,
            Name = item.Name,
            CostPerKg = item.CostPerKg,
            MaxUsage = item.MaxUsage,
            MinUsage = item.MinUsage,
            ADFContent = item.ADFContent,
            NDFContent = item.NDFContent
        };
        _dialogDelete = true;
    }

    public void DeleteItemConfirm()
    {
        _feeds.RemoveAt(_editedIndex);
        CloseDelete();
    }

    public void CloseDelete()
    {
        _dialogDelete = false;
        _editedItem = new();
        _editedIndex = -1;
    }
}
