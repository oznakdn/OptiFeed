@page "/feeds"
@using OptiFeed.Core.Models
@inject IFeedRepository FeedRepository


<MCard>
    <MCardTitle>
        <MSpacer></MSpacer>
        <MTextField @bind-Value="_search"
                    AppendIcon="mdi-magnify"
                    Label="Search"
                    SingleLine
                    HideDetails="true"></MTextField>
    </MCardTitle>
    <MDataTable Headers="_headers"
                Items="_feeds"
                Search="@_search"
                Class="elevation-1">
        <TopContent>
            <MToolbar Flat>
                <MToolbarTitle>Feeds</MToolbarTitle>
                <MDivider Class="mx-4"
                          Inset
                          Vertical></MDivider>
                <MSpacer></MSpacer>
                <MButton Color="primary"
                         Dark
                         Class="mb-2"
                         OnClick="()=>_dialog=true">
                    New Feed
                </MButton>
                <MDialog @bind-Value="_dialog"
                         MaxWidth="500">
                    <MCard>
                        <MCardTitle>
                            <span class="text-h5">@FormTitle</span>
                        </MCardTitle>

                        <MCardText>
                            <MContainer>
                                <MRow>
                                    <MCol Cols="12"
                                          Sm="12"
                                          Md="12">
                                        <MTextField @bind-Value="_editedItem.Name"
                                                    Label="Feed name"></MTextField>
                                    </MCol>
                                    <MCol Cols="12"
                                          Sm="6"
                                          Md="4">
                                        <MTextField @bind-Value="_editedItem.DryMatter"
                                                    Label="Dry Matter (%)"></MTextField>
                                    </MCol>
    using OptiFeed.Persistence.Repositories;
                                    <MCol Cols="12"
                                          Sm="6"
                                          Md="4">
                                        <MTextField @bind-Value="_editedItem.EnergyContent"
                                                    Label="EnergyContent (Mcal/kg)"></MTextField>
                                    </MCol>
                                    <MCol Cols="12"
                                          Sm="6"
                                          Md="4">
                                        <MTextField @bind-Value="_editedItem.ProteinContent"
                                                    Label="Protein (g/kg)"></MTextField>
                                    </MCol>
                                    <MCol Cols="12"
                                          Sm="6"
                                          Md="4">
                                        <MTextField @bind-Value="_editedItem.CostPerKg"
                                                    Label="Cost ($/kg)"></MTextField>
                                    </MCol>
                                    <MCol Cols="12"
                                          Sm="6"
                                          Md="4">
                                        <MTextField @bind-Value="_editedItem.MinUsage"
                                                    Label="MinUsage (%)"></MTextField>
                                    </MCol>
                                    <MCol Cols="12"
                                          Sm="6"
                                          Md="4">
                                        <MTextField @bind-Value="_editedItem.MaxUsage"
                                                    Label="MaxUsage (%)"></MTextField>
                                    </MCol>

                                </MRow>
                            </MContainer>
                        </MCardText>

                        <MCardActions>
                            <MSpacer></MSpacer>
                            <MButton Color="blue darken-1"
                                     Text
                                     OnClick="Close">
                                Cancel
                            </MButton>
                            <MButton Color="blue darken-1"
                                     Text
                                     OnClick="Save">
                                Save
                            </MButton>
                        </MCardActions>
                    </MCard>
                </MDialog>
                <MDialog @bind-Value="_dialogDelete" MaxWidth="500">
                    <MCard>
                        <MCardTitle Class="text-h5">Are you sure you want to delete this feed?</MCardTitle>
                        <MCardActions>
                            <MSpacer></MSpacer>
                            <MButton Color="blue darken-1" Text OnClick="CloseDelete">Cancel</MButton>
                            <MButton Color="blue darken-1" Text OnClick="DeleteItemConfirm">OK</MButton>
                            <MSpacer></MSpacer>
                        </MCardActions>
                    </MCard>
                </MDialog>
            </MToolbar>
        </TopContent>
        <ItemColContent>
            @if (context.Header.Value == "actions")
            {
                <MIcon Small
                       Class="mr-2"
                       OnClick="()=>EditItem(context.Item)">mdi-pencil</MIcon>
                <MIcon Small
                       OnClick="()=>DeleteItem(context.Item)">mdi-delete</MIcon>
            }
            else
            {
                @context.Value
            }
        </ItemColContent>
        <NoDataContent>
            <MButton Color="primary"
                     OnClick="Initialize">
                Reset
            </MButton>
        </NoDataContent>
    </MDataTable>
</MCard>
@code {

    private string _search;


    private List<DataTableHeader<Feed>> _headers = new List<DataTableHeader<Feed>>
{
          new (){ Text= "Name", Value= nameof(Feed.Name),Sortable = true},
          new (){ Text= "Dry Matter (%)", Value= nameof(Feed.DryMatter),Sortable = true},
          new (){ Text= "Energy (Mcal/kg)", Value= nameof(Feed.EnergyContent),Sortable = true},
          new (){ Text= "Protein (g/kg)", Value= nameof(Feed.ProteinContent),Sortable = true},
          new (){ Text= "ADF (%/kg)", Value= nameof(Feed.ProteinContent),Sortable = false},
          new (){ Text= "NDF (%/kg)", Value= nameof(Feed.ProteinContent),Sortable = false},
          new (){ Text= "Cost ($/kg)", Value= nameof(Feed.CostPerKg),Sortable = true},
          new (){ Text= "Min Usage (%)", Value= nameof(Feed.MaxUsage),Sortable = true},
          new (){ Text= "Max Usage (%)", Value= nameof(Feed.MaxUsage),Sortable = true},
          new (){ Text= "Actions", Value= "actions",Sortable=false }
    };

    private IList<Feed> _feeds;

    private bool _dialog;
    private bool _dialogDelete;
    private Feed _editedItem = new Feed
    {
        Name = "",
        DryMatter = 0,
        ProteinContent = 0,
        EnergyContent = 0,
        CostPerKg = 0,
        MaxUsage = 0,
        ADFContent = 0,
        NDFContent = 0
    };
    private int _editedIndex = -1;

    public string FormTitle
    {
        get
        {
            return _editedIndex == -1 ? "New Feed" : "Edit Feed";
        }
    }

    protected override async Task OnInitializedAsync()
    {
       await Initialize();
    }


   


    public async Task Initialize()
    {
        _feeds = await FeedRepository.GetFeedsAsync();
    }

    public void Close()
    {
        _dialog = false;
        _editedItem = new Feed();
        _editedIndex = -1;
    }

    public void Save()
    {
        if (_editedIndex > -1)
        {
            var item = _feeds[_editedIndex];
            item.MaxUsage = _editedItem.MaxUsage;
            item.MinUsage = _editedItem.MinUsage;
            item.DryMatter = _editedItem.DryMatter;
            item.EnergyContent = _editedItem.EnergyContent;
            item.ProteinContent = _editedItem.ProteinContent;
            item.CostPerKg = _editedItem.CostPerKg;
            item.Name = _editedItem.Name;
            item.ADFContent = _editedItem.ADFContent;
            item.NDFContent = _editedItem.NDFContent;

        }
        else
        {
            _feeds.Add(_editedItem);
        }
        Close();
    }

    public void EditItem(Feed item)
    {
        _editedIndex = _feeds.IndexOf(item);
        _editedItem = new Feed()
        {
            DryMatter = item.DryMatter,
            EnergyContent = item.EnergyContent,
            ProteinContent = item.ProteinContent,
            Name = item.Name,
            CostPerKg = item.CostPerKg,
            MaxUsage = item.MaxUsage,
            MinUsage = item.MinUsage,
            ADFContent = item.ADFContent,
            NDFContent = item.NDFContent
        };
        _dialog = true;
    }

    public void DeleteItem(Feed item)
    {
        _editedIndex = _feeds.IndexOf(item);
        _editedItem = new Feed()
        {
            DryMatter = item.DryMatter,
            EnergyContent = item.EnergyContent,
            ProteinContent = item.ProteinContent,
            Name = item.Name,
            CostPerKg = item.CostPerKg,
            MaxUsage = item.MaxUsage,
            MinUsage = item.MinUsage,
            ADFContent = item.ADFContent,
            NDFContent = item.NDFContent
        };
        _dialogDelete = true;
    }

    public void DeleteItemConfirm()
    {
        _feeds.RemoveAt(_editedIndex);
        CloseDelete();
    }

    public void CloseDelete()
    {
        _dialogDelete = false;
        _editedItem = new();
        _editedIndex = -1;
    }
}
